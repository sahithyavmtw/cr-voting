<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Branch & Section CR Voting</title>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">

<div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-lg">

<h1 class="text-2xl font-bold text-center text-indigo-600 mb-4">
üó≥Ô∏è Branch & Section CR Voting
</h1>

<p id="deadlineMsg" class="text-center text-sm text-red-500 font-semibold mb-3"></p>

<!-- Branch -->
<label class="font-semibold">Branch</label>
<select id="branchSelect" class="w-full mb-3 px-4 py-2 border-2 rounded-lg">
  <option value="AIML">AIML</option>
  <option value="CSE">CSE</option>
  <option value="IT">IT</option>
</select>

<!-- Section -->
<label class="font-semibold">Section</label>
<select id="sectionSelect" class="w-full mb-3 px-4 py-2 border-2 rounded-lg">
  <option value="A">A</option>
  <option value="B">B</option>
  <option value="C">C</option>
</select>

<!-- Student -->
<label class="font-semibold">Student Name</label>
<input id="studentName" class="w-full mb-3 px-4 py-2 border-2 rounded-lg" placeholder="Enter name">

<!-- Candidate -->
<label class="font-semibold">Candidate</label>
<select id="candidateSelect" class="w-full mb-3 px-4 py-2 border-2 rounded-lg"></select>

<!-- Buttons -->
<div class="grid grid-cols-2 gap-3">
  <button id="voteBtn" class="bg-green-500 text-white py-2 rounded-lg font-semibold">Vote</button>
  <button id="clearBtn" class="bg-red-500 text-white py-2 rounded-lg font-semibold">Reset</button>
</div>

<!-- Export -->
<div class="grid grid-cols-2 gap-3 mt-3">
  <button onclick="exportExcel()" class="bg-blue-500 text-white py-2 rounded-lg">Excel</button>
  <button onclick="exportPDF()" class="bg-purple-500 text-white py-2 rounded-lg">PDF</button>
</div>

<div id="msg" class="mt-4 text-center font-semibold"></div>
<div id="winner" class="mt-3 text-center text-lg font-bold text-purple-600"></div>

<div class="mt-5">
  <h2 class="font-bold">üìä Vote Status</h2>
  <div id="voteStatus"></div>
</div>

<canvas id="chart" class="mt-5"></canvas>

<div class="mt-5 bg-gray-100 p-3 rounded-lg">
  <h2 class="font-bold">üßë‚Äçüéì Voted Students</h2>
  <ul id="studentList" class="text-sm"></ul>
</div>

</div>

<script>
/* üîí Deadline */
const DEADLINE = new Date("2026-02-01T18:00:00");

/* üßë‚Äçüéì Branch‚ÄìSection Candidate Mapping */
const candidatesMap = {
  AIML: {
    A: ["Sahithya", "Sony", "Charitha", "Poojitha"],
    B: ["Varalaxmi", "Sowmya", "Shahana Begum", "Ramya"],
    C: ["Akshaya", "Priya", "Riya", "Kavya"]
  },
  CSE: {
    A: ["Laxmi", "Meena", "Rinna"],
    B: ["Anu", "Divya", "Navya"],
    C: ["Akhila", "Pooja", "Divya", "Deepika"]
  },
  IT: {
    A: ["Sahithi", "Ayesha", "Swathi", "Manasa"],
    B: ["Srija", "Kavya", "Navya"],
    C: ["Vaishnavi", "Sneha", "Prerana"]
  }
};

let chart;

/* üîë Storage helpers */
function storageKey() {
  return `data_${branchSelect.value}_${sectionSelect.value}`;
}

function getData() {
  return JSON.parse(localStorage.getItem(storageKey())) || { votes:{}, students:[] };
}

function saveData(d) {
  localStorage.setItem(storageKey(), JSON.stringify(d));
}

/* üîÅ Update candidates */
function updateCandidates() {
  candidateSelect.innerHTML = "";
  candidatesMap[branchSelect.value][sectionSelect.value].forEach(c => {
    const opt = document.createElement("option");
    opt.textContent = c;
    candidateSelect.appendChild(opt);
  });
  updateUI();
}

/* ‚è∞ Deadline */
function votingClosed() {
  return new Date() > DEADLINE;
}

function updateDeadline() {
  deadlineMsg.textContent = votingClosed()
    ? "‚õî Voting Closed"
    : "üïí Ends: " + DEADLINE.toLocaleString();
}

/* üó≥Ô∏è Vote */
voteBtn.onclick = () => {
  if (votingClosed()) {
    msg.textContent = "‚õî Voting is closed!";
    msg.className = "text-red-600";
    return;
  }

  const name = studentName.value.trim().toLowerCase();
  const cand = candidateSelect.value;

  if (!name) return alert("Enter student name");
  if (!confirm(`Confirm vote for ${cand}?`)) return;

  let data = getData();

  if (data.students.includes(name)) {
    msg.textContent = "‚ùå Already voted!";
    msg.className = "text-red-500";
    return;
  }

  data.students.push(name);
  data.votes[cand] = (data.votes[cand] || 0) + 1;
  saveData(data);

  msg.textContent = "‚úÖ Vote submitted";
  msg.className = "text-green-600";
  studentName.value = "";
  updateUI();
};

/* ‚ôª Reset */
clearBtn.onclick = () => {
  if (confirm("Clear votes for this branch & section?")) {
    localStorage.removeItem(storageKey());
    updateUI();
  }
};

/* üîÑ UI */
function updateUI() {
  const d = getData();
  voteStatus.innerHTML = "";
  studentList.innerHTML = "";

  let max = 0, win = "", total = 0;

  for (let c in d.votes) {
    voteStatus.innerHTML += `<p>${c}: ${d.votes[c]}</p>`;
    total += d.votes[c];
    if (d.votes[c] > max) {
      max = d.votes[c];
      win = c;
    }
  }

  winner.textContent = win ? `üèÜ Leading: ${win}` : "";
  d.students.forEach(s => studentList.innerHTML += `<li>‚úî ${s}</li>`);

  drawLeaderChart(d.votes, win, max, total);
}

/* ü•ß Leader Pie Chart */
function drawLeaderChart(votes, leader, leaderVotes, totalVotes) {
  if (chart) chart.destroy();
  if (!leader) {
    document.getElementById("chart").style.display = "none";
    return;
  }

  document.getElementById("chart").style.display = "block";

  chart = new Chart(document.getElementById("chart"), {
    type: "pie",
    data: {
      labels: [`üèÜ ${leader}`, "Others"],
      datasets: [{
        data: [leaderVotes, totalVotes - leaderVotes],
        backgroundColor: ["#22c55e", "#e5e7eb"]
      }]
    },
    options: {
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
}

/* üì• Export */
function exportExcel() {
  const d = getData();
  const rows = [["Candidate","Votes"]];
  for (let c in d.votes) rows.push([c,d.votes[c]]);
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Results");
  XLSX.writeFile(wb, `${branchSelect.value}_${sectionSelect.value}.xlsx`);
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text(`${branchSelect.value} - ${sectionSelect.value} Results`, 20, 20);
  let y = 40;
  const d = getData();
  for (let c in d.votes) {
    pdf.text(`${c}: ${d.votes[c]}`, 20, y);
    y += 10;
  }
  pdf.save(`${branchSelect.value}_${sectionSelect.value}_Results.pdf`);
}

/* üîÅ Events */
branchSelect.onchange = sectionSelect.onchange = updateCandidates;

/* Init */
updateDeadline();
updateCandidates();
</script>

</body>
</html>
